# Система быстрого деплоя проекта

Этот набор скриптов позволяет быстро деплоить ваш микросервисный проект с кэшированием зависимостей Maven и автоматическим мониторингом изменений.

## Содержание

- [Быстрый старт](#быстрый-старт)
- [Основные команды](#основные-команды)
- [Скрипты](#скрипты)
- [Makefile](#makefile)
- [Мониторинг изменений](#мониторинг-изменений)
- [Устранение неполадок](#устранение-неполадок)

## Быстрый старт

### 1. Установка зависимостей

```bash
# Установка fswatch для мониторинга изменений (macOS)
brew install fswatch

# Установка fswatch (Ubuntu/Debian)
sudo apt-get install fswatch

# Установка fswatch (CentOS/RHEL)
sudo yum install fswatch
```

### 2. Настройка прав доступа

```bash
# Установка прав на выполнение скриптов
cd deploy
make setup
```

### 3. Первый запуск

```bash
# Быстрый деплой в dev режиме
cd deploy
make dev

# Или используя скрипт
cd deploy/scripts
./deploy.sh
```

## Основные команды

### Использование Makefile (рекомендуется)

```bash
cd deploy

# Быстрый деплой
make dev

# Принудительная пересборка (при изменении зависимостей)
make force

# Очистка всего
make clean

# Мониторинг изменений в user-service
make watch-user

# Пересборка только одного сервиса
make rebuild-user
```

### Использование скриптов

```bash
cd deploy/scripts

# Быстрый деплой
./deploy.sh

# Принудительная пересборка
./deploy.sh -f

# Деплой в production
./deploy.sh -e prod

# Пересборка только user-service
./deploy.sh -s user-service

# Очистка всего
./deploy.sh -c
```

## Скрипты

### deploy.sh - Основной скрипт деплоя

**Опции:**
- `-h, --help` - Показать справку
- `-e, --env ENV` - Окружение (dev/prod) [по умолчанию: dev]
- `-f, --force` - Принудительная пересборка (без кэша)
- `-c, --clean` - Очистить все контейнеры и образы
- `-s, --service SERVICE` - Пересобрать только конкретный сервис
- `-d, --down` - Остановить все сервисы
- `-l, --logs` - Показать логи
- `-r, --restart` - Перезапустить сервисы

**Примеры:**
```bash
./deploy.sh                     # Быстрый деплой в dev режиме
./deploy.sh -e prod             # Деплой в production режиме
./deploy.sh -f                  # Принудительная пересборка
./deploy.sh -s user-service     # Пересобрать только user-service
./deploy.sh -c                  # Очистить всё
./deploy.sh -l                  # Показать логи
```

### watch.sh - Мониторинг изменений

**Опции:**
- `-h, --help` - Показать справку
- `-s, --service SERVICE` - Сервис для мониторинга

**Примеры:**
```bash
./watch.sh -s user-service     # Мониторинг user-service
./watch.sh -s point-service    # Мониторинг point-service
./watch.sh -s statistic-service # Мониторинг statistic-service
```

### local-start.sh - Локальный запуск

**Команды:**
- `start` - Запуск всех сервисов
- `stop` - Остановка всех сервисов
- `restart` - Перезапуск всех сервисов
- `status` - Статус всех сервисов
- `build` - Только сборка проекта
- `logs` - Показать логи
- `clean` - Очистка логов и PID файлов

**Примеры:**
```bash
./local-start.sh start         # Запуск всех сервисов
./local-start.sh stop          # Остановка всех сервисов
./local-start.sh status        # Проверка статуса
```

## Makefile

### Основные команды

```bash
cd deploy

make help              # Показать справку
make dev               # Быстрый деплой в dev режиме
make prod              # Деплой в production режиме
make build             # Сборка образов
make up                # Запуск сервисов
make down              # Остановка сервисов
make restart           # Перезапуск сервисов
make logs              # Показать логи
```

### Управление кэшем

```bash
make force             # Принудительная пересборка (без кэша)
make clean             # Очистить все контейнеры и образы
```

### Мониторинг изменений

```bash
make watch-user        # Автоматический перезапуск user-service
make watch-point       # Автоматический перезапуск point-service
make watch-statistic   # Автоматический перезапуск statistic-service
make watch-all         # Мониторинг всех сервисов (умный режим)
make watch-all-simple  # Мониторинг всех сервисов (упрощенный режим)
make watch-all-ultra   # Ультра-простой мониторинг (рекомендуется)
```

### Отдельные сервисы

```bash
make build-user        # Сборка только user-service
make build-point       # Сборка только point-service
make build-statistic   # Сборка только statistic-service
make rebuild-user      # Быстрая пересборка user-service
make rebuild-point     # Быстрая пересборка point-service
make rebuild-statistic # Быстрая пересборка statistic-service
```

## Мониторинг изменений

Система автоматически отслеживает изменения в коде и перезапускает соответствующие сервисы:

### Запуск мониторинга

```bash
cd deploy

# Мониторинг user-service
make watch-user

# Мониторинг point-service
make watch-point

# Мониторинг statistic-service
make watch-statistic

# Мониторинг всех сервисов (умный режим)
make watch-all

# Мониторинг всех сервисов (упрощенный режим)
make watch-all-simple
```

### Что отслеживается

- **user-service**: `../user/src`, `../common/src`
- **point-service**: `../point/src`, `../common/src`
- **statistic-service**: `../statistic/src`, `../common/src`

### Режимы мониторинга всех сервисов

#### Умный режим (`make watch-all`)
- Отслеживает конкретные файлы
- Перезапускает только затронутые сервисы
- При изменении `common/src` перезапускает все сервисы
- Более эффективно, но сложнее

#### Упрощенный режим (`make watch-all-simple`)
- Перезапускает все сервисы при любом изменении
- Проще и быстрее
- Менее эффективно при частых изменениях

### Преимущества

- Изменения в коде сразу фиксируются в деплое
- Не нужно вручную перезапускать сервисы
- Кэширование зависимостей Maven
- Быстрая пересборка только измененных сервисов

## Рабочий процесс разработки

### 1. Первый запуск
```bash
cd deploy
make dev
```

### 2. Разработка с автоматическим перезапуском
```bash
# В одном терминале
cd deploy
make watch-all

# В другом терминале редактируете код
# Сервис автоматически перезапустится при сохранении
```

### 3. При изменении зависимостей
```bash
cd deploy
make force
```

### 4. Быстрая пересборка одного сервиса
```bash
cd deploy
make rebuild-user
```

## Доступные сервисы

После успешного деплоя доступны:

- **User Service**: http://localhost:8090
- **Point Service**: http://localhost:8091
- **Statistic Service**: http://localhost:8095
- **Grafana**: http://localhost:3000 (admin/admin)
- **Prometheus**: http://localhost:9090
- **RabbitMQ Management**: http://localhost:15673 (guest/guest)

## Устранение неполадок

### Проблема: Зависимости не кэшируются

**Решение:**
```bash
cd deploy
# Принудительная пересборка
make force

# Или очистка и повторная сборка
make clean
make dev
```

### Проблема: Сервис не перезапускается при изменениях

**Решение:**
```bash
# Проверьте, что fswatch установлен
which fswatch

# Если не установлен
brew install fswatch  # macOS
sudo apt-get install fswatch  # Ubuntu
```

### Проблема: Конфликт портов

**Решение:**
```bash
cd deploy
# Остановка всех сервисов
make down

# Проверка занятых портов
lsof -i :8090
lsof -i :8091
lsof -i :8095

# Очистка и повторный запуск
make clean
make dev
```

### Проблема: Недостаточно места на диске

**Решение:**
```bash
# Очистка Docker
docker system prune -a

# Очистка проекта
cd deploy
make clean
```

## Производительность

### Время сборки (примерно)

- **Первая сборка**: 5-10 минут (загрузка зависимостей)
- **Повторная сборка**: 30-60 секунд (с кэшем)
- **Пересборка одного сервиса**: 10-20 секунд
- **Автоматический перезапуск**: 5-10 секунд

### Оптимизации

- Кэширование Maven зависимостей
- Многоэтапная сборка Docker
- Пересборка только измененных сервисов
- Volume mounts для hot reload

## Настройка

### Переменные окружения

Скрипты автоматически определяют окружение:
- **dev**: использует `../docker-compose.dev.yml`
- **prod**: использует `../docker-compose.yml`

### Кастомизация

Для изменения настроек отредактируйте:
- `../docker-compose.dev.yml` - настройки разработки
- `../docker-compose.yml` - настройки production
- `Makefile` - команды сборки
- `scripts/deploy.sh` - логика деплоя

## Логи

### Просмотр логов

```bash
cd deploy

# Все сервисы
make logs

# Конкретный сервис
docker-compose -f ../docker-compose.dev.yml logs -f user-service
```

### Логи приложения

Логи сохраняются в:
- `../user/cache_metrics.log`
- `../point/cache_metrics.log`
- `../statistic/cache_metrics.log`

## Готово!

Теперь у вас есть мощная система для быстрого деплоя с автоматическим мониторингом изменений. Изменения в коде будут сразу фиксироваться в деплое без необходимости ждать часами загрузки зависимостей! 