FROM openjdk:21-jdk-slim

WORKDIR /app



# Этап 1: Копируем только файлы для зависимостей
COPY mvnw .
COPY mvnw.cmd .
COPY pom.xml .
COPY .mvn .mvn
COPY user/pom.xml ./user/pom.xml
COPY point/pom.xml ./point/pom.xml
COPY statistic/pom.xml ./statistic/pom.xml
COPY common/pom.xml ./common/pom.xml

# Этап 2: Скачиваем зависимости (кэшируется отдельно)
RUN ./mvnw dependency:go-offline -pl point -am

# Этап 3: Копируем исходный код (меняется часто)
COPY point/src ./point/src
COPY common/src ./common/src

# Этап 4: Компилируем (кэшируется отдельно)
RUN ./mvnw compile -pl point -am -DskipTests

# Этап 5: Создаем JAR (меняется при изменении кода)
RUN ./mvnw package -pl point -am -DskipTests

# Создаем директорию для приложения
RUN mkdir -p /app/target

# Копируем собранный JAR файл
RUN cp point/target/*.jar /app/target/app.jar

# Открываем порты
EXPOSE 8091 8062

# Запускаем приложение
CMD ["java", "-jar", "/app/target/app.jar"] 